<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Message.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">minicp:minicp</a> &gt; <a href="index.source.html" class="el_package">minicp.util.io.cpprofilerbridge</a> &gt; <span class="el_source">Message.java</span></div><h1>Message.java</h1><pre class="source lang-java linenums">package minicp.util.io.cpprofilerbridge;

import java.io.ByteArrayOutputStream;
import java.io.DataOutputStream;
import java.io.IOException;
import java.nio.ByteBuffer;
import java.nio.ByteOrder;
import java.nio.charset.StandardCharsets;

public final class Message {
    // ATTRIBUTE
    private int msgType;
    private int restartId;
    private int nodeId;
    private int nodePid;
    private int nodeAlt;
    private int nodeChildren;
    private int nodeStatus;
    private String nodeLabel;
    private String nodeNoGood;
    private String nodeInfo;
    private String restartLabel;
    private Connector connector_;

    // ENUMERATION
<span class="nc" id="L26">    public enum MsgType {</span>
<span class="nc" id="L27">        NODE(0),</span>
<span class="nc" id="L28">        DONE(1),</span>
<span class="nc" id="L29">        START(2),</span>
<span class="nc" id="L30">        RESTART(3);</span>

        private final int id;
<span class="nc" id="L33">        private MsgType(int id) { this.id = id; }</span>
<span class="nc" id="L34">        public int getNumber() { return id; }</span>
    }

<span class="nc" id="L37">    public enum OptionalArgs {</span>
<span class="nc" id="L38">        LABEL(0),</span>
<span class="nc" id="L39">        NOGOOD(1),</span>
<span class="nc" id="L40">        INFO(2);</span>

        private final int id;
<span class="nc" id="L43">        private OptionalArgs(int id) { this.id = id; }</span>
<span class="nc" id="L44">        public int getNumber() { return id; }</span>
    }

    // CONSTRUCTOR
<span class="nc" id="L48">    public Message(Connector connector) {</span>
<span class="nc" id="L49">        this.connector_ = connector;</span>
<span class="nc" id="L50">        this.clear();</span>
<span class="nc" id="L51">    }</span>

    // SETTER
    public Message setType(MsgType type) {
<span class="nc" id="L55">        this.msgType = type.getNumber();</span>
<span class="nc" id="L56">        return this;</span>
    }
    public Message setLabel(String label) {
<span class="nc" id="L59">        this.restartLabel = label;</span>
<span class="nc" id="L60">        return this;</span>
    }
    public Message setRestartId(int id) {
<span class="nc" id="L63">        this.restartId = id;</span>
<span class="nc" id="L64">        return this;</span>
    }
    public Message setNodePid(int pid) {
<span class="nc" id="L67">        this.nodePid = pid;</span>
<span class="nc" id="L68">        return this;</span>
    }
    public Message setNodeAlt(int alt) {
<span class="nc" id="L71">        this.nodeAlt = alt;</span>
<span class="nc" id="L72">        return this;</span>
    }
    public Message setNodeChildren(int c) {
<span class="nc" id="L75">        this.nodeChildren = c;</span>
<span class="nc" id="L76">        return this;</span>
    }
    public Message setNoteStatus(int status) {
<span class="nc" id="L79">        this.nodeStatus = status;</span>
<span class="nc" id="L80">        return this;</span>
    }
    public Message setNodeId(int id) {
<span class="nc" id="L83">        this.nodeId = id;</span>
<span class="nc" id="L84">        return this;</span>
    }
    public Message setNodeRestartId(int id) {
<span class="nc" id="L87">        this.nodeId = id;</span>
<span class="nc" id="L88">        return this;</span>
    }
    public Message setNodeLabel(String data) {
<span class="nc" id="L91">        this.nodeLabel = data;</span>
<span class="nc" id="L92">        return this;</span>
    }
    public Message setNodeNoGood(String data) {
<span class="nc" id="L95">        this.nodeNoGood = data;</span>
<span class="nc" id="L96">        return this;</span>
    }
    public Message setNodeInfo(String data) {
<span class="nc" id="L99">        this.nodeInfo = data;</span>
<span class="nc" id="L100">        return  this;</span>
    }
    public void send() {
        try {
<span class="nc" id="L104">            this.connector_.sendNode(this);</span>
<span class="nc" id="L105">        } catch (IOException e) {</span>
<span class="nc" id="L106">            e.printStackTrace();</span>
<span class="nc" id="L107">        } catch (InterruptedException e) {</span>
<span class="nc" id="L108">            e.printStackTrace();</span>
<span class="nc" id="L109">        }</span>
<span class="nc" id="L110">    }</span>

    // PUBLIC METHODS
    public byte[] toBytes() throws IOException {
<span class="nc" id="L114">        System.out.println(&quot;\n&quot;+this.toString()+&quot;\n&quot;);</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">        if(this.msgType == MsgType.DONE.getNumber()) {</span>
<span class="nc" id="L116">            return this.convertToBytes(MsgType.DONE.getNumber(), 1);</span>
        }
<span class="nc bnc" id="L118" title="All 2 branches missed.">        else if(this.msgType == MsgType.START.getNumber()){</span>
            // CREATE OUTPUT STREAM
<span class="nc" id="L120">            ByteArrayOutputStream outputStream = new ByteArrayOutputStream( );</span>

            // LET PREPARE REQUIRED ARGS
<span class="nc" id="L123">            byte[] msg_type = this.convertToBytes(MsgType.START.getNumber(), 1);</span>
<span class="nc" id="L124">            outputStream.write( msg_type );</span>

            // OPTIONAL PARAMETERS
<span class="nc bnc" id="L127" title="All 2 branches missed.">            if(restartLabel != &quot;-&quot;) {</span>
<span class="nc" id="L128">                byte[] msg_info = this.convertToBytes(OptionalArgs.INFO.getNumber(), 1);</span>

                // CONFIG FZN FILE TITLE(CPP SIDE)
<span class="nc" id="L131">                String reformat_data = &quot;{\&quot;name\&quot;: \&quot;&quot; + this.restartLabel + &quot;\&quot;}&quot;;</span>
<span class="nc" id="L132">                byte[] msg_data = reformat_data.getBytes(StandardCharsets.UTF_8);</span>

                // INFO DATA SIZE
<span class="nc" id="L135">                byte[] size_data = this.convertToBytes(msg_data.length, 4, &quot;BIG_ENDIAN&quot;);</span>

                // GROUPED DATA
<span class="nc" id="L138">                outputStream.write( msg_info );</span>
<span class="nc" id="L139">                outputStream.write( size_data );</span>
<span class="nc" id="L140">                outputStream.write( msg_data );</span>
            }
<span class="nc" id="L142">            return outputStream.toByteArray();</span>
        }
<span class="nc bnc" id="L144" title="All 2 branches missed.">        else if(this.msgType == MsgType.RESTART.getNumber()){</span>
<span class="nc" id="L145">            byte[] msg_type = this.convertToBytes(MsgType.RESTART.getNumber(), 1);</span>
<span class="nc" id="L146">            return msg_type;</span>
        }
<span class="nc bnc" id="L148" title="All 2 branches missed.">        else if(this.msgType == MsgType.NODE.getNumber()){</span>
            // CREATE OUTPUT STREAM
<span class="nc" id="L150">            ByteArrayOutputStream outputStream = new ByteArrayOutputStream( );</span>

            // LET PREPARE REQUIRED ARGS
<span class="nc" id="L153">            byte[] msg_type = this.convertToBytes(MsgType.NODE.getNumber(), 1);</span>
            // Id-[12bytes]
<span class="nc" id="L155">            byte[] node_id = this.convertToBytes(this.nodeId, 4, &quot;BIG_ENDIAN&quot;);</span>
<span class="nc" id="L156">            byte[] node_restart_id = this.convertToBytes(restartId, 4,&quot;BIG_ENDIAN&quot;);</span>
<span class="nc" id="L157">            byte[] node_thread_id = this.convertToBytes(-1, 4,&quot;BIG_ENDIAN&quot;);</span>
            // Pid-[12bytes]
<span class="nc" id="L159">            byte[] parent_id = this.convertToBytes(this.nodePid, 4,&quot;BIG_ENDIAN&quot;);</span>
<span class="nc" id="L160">            byte[] parent_restart_id = this.convertToBytes(restartId, 4,&quot;BIG_ENDIAN&quot;);</span>
<span class="nc" id="L161">            byte[] parent_thread_id = this.convertToBytes(-1, 4,&quot;BIG_ENDIAN&quot;);</span>
            // Alt-&amp;-kids-[4bytes]
<span class="nc" id="L163">            byte[] msg_alt = this.convertToBytes(this.nodeAlt, 4,&quot;BIG_ENDIAN&quot;);</span>
<span class="nc" id="L164">            byte[] msg_kid = this.convertToBytes(this.nodeChildren, 4,&quot;BIG_ENDIAN&quot;);</span>
            // Status-[1bytes]
<span class="nc" id="L166">            byte[] msg_status = this.convertToBytes(nodeStatus, 1);</span>

            // WRITE REQUIRED ARGS
<span class="nc" id="L169">            outputStream.write( msg_type );</span>
<span class="nc" id="L170">            outputStream.write( node_id );</span>
<span class="nc" id="L171">            outputStream.write( node_restart_id );</span>
<span class="nc" id="L172">            outputStream.write( node_thread_id );</span>
<span class="nc" id="L173">            outputStream.write( parent_id );</span>
<span class="nc" id="L174">            outputStream.write( parent_restart_id );</span>
<span class="nc" id="L175">            outputStream.write( parent_thread_id );</span>
<span class="nc" id="L176">            outputStream.write( msg_alt );</span>
<span class="nc" id="L177">            outputStream.write( msg_kid );</span>
<span class="nc" id="L178">            outputStream.write( msg_status );</span>

            // LET PREPARE OPTIONAL ARGS
<span class="nc bnc" id="L181" title="All 2 branches missed.">            if(nodeLabel != &quot;-&quot;) {</span>
<span class="nc" id="L182">                byte[] msg_label = this.convertToBytes(OptionalArgs.LABEL.getNumber(), 1);</span>
<span class="nc" id="L183">                byte[] msg_data1 = nodeLabel.getBytes(StandardCharsets.UTF_8);</span>
<span class="nc" id="L184">                byte[] size_data1 = this.convertToBytes(msg_data1.length, 4, &quot;BIG_ENDIAN&quot;);</span>
<span class="nc" id="L185">                outputStream.write( msg_label );</span>
<span class="nc" id="L186">                outputStream.write( size_data1 );</span>
<span class="nc" id="L187">                outputStream.write( msg_data1 );</span>
            }
<span class="nc bnc" id="L189" title="All 2 branches missed.">            if(nodeNoGood != &quot;-&quot;) {</span>
<span class="nc" id="L190">                byte[] msg_nogood = this.convertToBytes(OptionalArgs.NOGOOD.getNumber(), 1);</span>
<span class="nc" id="L191">                byte[] msg_data2 = nodeLabel.getBytes(StandardCharsets.UTF_8);</span>
<span class="nc" id="L192">                byte[] size_data2 = this.convertToBytes(msg_data2.length, 4, &quot;BIG_ENDIAN&quot;);</span>
<span class="nc" id="L193">                outputStream.write( msg_nogood );</span>
<span class="nc" id="L194">                outputStream.write( size_data2 );</span>
<span class="nc" id="L195">                outputStream.write( msg_data2 );</span>
            }
<span class="nc bnc" id="L197" title="All 2 branches missed.">            if(nodeInfo != &quot;-&quot;) {</span>
<span class="nc" id="L198">                byte[] msg_info = this.convertToBytes(OptionalArgs.INFO.getNumber(), 1);</span>

                // CONFIG FZN FILE TITLE(CPP SIDE)
<span class="nc" id="L201">                String reformat_data = &quot;{\&quot;name\&quot;: \&quot;&quot; + this.nodeInfo + &quot;\&quot;}&quot;;</span>
<span class="nc" id="L202">                byte[] msg_data3 = reformat_data.getBytes(StandardCharsets.UTF_8);</span>

                // INFO DATA SIZE
<span class="nc" id="L205">                byte[] size_data3 = this.convertToBytes(msg_data3.length, 4, &quot;BIG_ENDIAN&quot;);</span>

<span class="nc" id="L207">                outputStream.write( msg_info );</span>
<span class="nc" id="L208">                outputStream.write( size_data3 );</span>
<span class="nc" id="L209">                outputStream.write( msg_data3 );</span>
            }

            //SEND FINAL RESULT
<span class="nc" id="L213">            return outputStream.toByteArray();</span>
        }
        else{
            // DEFAULT STATE, END GRAPH BUILD
<span class="nc" id="L217">            return this.convertToBytes(MsgType.DONE.getNumber(), 1);</span>
        }
    }

    public void clear() {
<span class="nc" id="L222">        msgType = 0;</span>
        //restartId = -1;
<span class="nc" id="L224">        nodeId = 0;</span>
<span class="nc" id="L225">        nodePid = 0;</span>
<span class="nc" id="L226">        nodeAlt = 0;</span>
<span class="nc" id="L227">        nodeChildren = 0;</span>
<span class="nc" id="L228">        nodeStatus = 0;</span>
<span class="nc" id="L229">        nodeLabel = &quot;-&quot;;</span>
<span class="nc" id="L230">        nodeNoGood = &quot;-&quot;;</span>
<span class="nc" id="L231">        nodeInfo = &quot;-&quot;;</span>
<span class="nc" id="L232">        restartLabel = &quot;-&quot;;</span>
<span class="nc" id="L233">    }</span>

    public String toString() {
<span class="nc" id="L236">        return &quot;{\n&quot; +</span>
                &quot;\t'msgType': &quot;+msgType+&quot;,\n&quot; +
                &quot;\t'nodeId': &quot;+nodeId+&quot;,\n&quot; +
                &quot;\t'nodePid': &quot;+nodePid+&quot;,\n&quot; +
                &quot;\t'nodeAlt': &quot;+nodeAlt+&quot;,\n&quot; +
                &quot;\t'nodeChildren': &quot;+nodeChildren+&quot;,\n&quot; +
                &quot;\t'nodeStatus': &quot;+nodeStatus+&quot;,\n&quot; +
                &quot;\t'nodeLabel': &quot;+nodeLabel+&quot;,\n&quot; +
                &quot;\t'nodeNoGood': &quot;+nodeNoGood+&quot;,\n&quot; +
                &quot;\t'nodeInfo': &quot;+nodeInfo+&quot;,\n&quot; +
                &quot;\t'restartId': &quot;+restartId+&quot;,\n&quot; +
                &quot;\t'restartLabel': &quot;+restartLabel+&quot;\n}&quot;;
    }

    //PRIVATE METHODS
    private byte[] convertToBytes(int data, int byte_size){
<span class="nc" id="L252">        byte[] msg_bytes_tab = new byte[byte_size];</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">        for (int i = 0; i &lt; byte_size; i++) {</span>
<span class="nc" id="L254">            msg_bytes_tab[i] = (byte)((data &gt;&gt;&gt; (i * 8) &amp; 0xff));</span>
        }
<span class="nc" id="L256">        return msg_bytes_tab;</span>
    }
    private byte[] convertToBytes(int data, int byte_size, String BIG_ENDIAN){
<span class="nc" id="L259">        byte[] msg_bytes_tab = new byte[byte_size];</span>
<span class="nc" id="L260">        ByteBuffer.wrap(msg_bytes_tab).order(ByteOrder.BIG_ENDIAN).putInt(data);</span>
<span class="nc" id="L261">        return msg_bytes_tab;</span>
    }
    private byte[] intToBytes_( final int i ) {
<span class="nc" id="L264">        ByteBuffer bb = ByteBuffer.allocate(4);</span>
<span class="nc" id="L265">        bb.putInt(i);</span>
<span class="nc" id="L266">        return bb.array();</span>
    }
    private byte[] intToByteArray ( final int i ) throws IOException {
<span class="nc" id="L269">        ByteArrayOutputStream bos = new ByteArrayOutputStream();</span>
<span class="nc" id="L270">        DataOutputStream dos = new DataOutputStream(bos);</span>
<span class="nc" id="L271">        dos.writeInt(i);</span>
<span class="nc" id="L272">        dos.flush();</span>
<span class="nc" id="L273">        return bos.toByteArray();</span>
    }
    private byte[] intToBytes(final int data) {
<span class="nc" id="L276">        return new byte[] {</span>
                (byte)((data &gt;&gt; 24) &amp; 0xff),
                (byte)((data &gt;&gt; 16) &amp; 0xff),
                (byte)((data &gt;&gt; 8) &amp; 0xff),
                (byte)((data) &amp; 0xff),
        };
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>